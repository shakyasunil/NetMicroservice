name: "Build for PRe"
description: "Builds a docker image without pushing"
inputs:
  service:
    description: "Service to build"
    required: true
  dotnet_version:
    description: "Service to build"
    required: true
runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v2
  - name: Setup .NET Core
    uses: actions/setup-dotnet@v1
    with:
      dotnet-version: ${{ inputs.dotnet_version }}  
  - name: Install dependencies
    run: dotnet restore
    shell: pwsh
    working-directory: ./services/${{ inputs.service }}  
  - name: Compose build ${{ inputs.service }}
    shell: pwsh
    run: |
      $outputDirectory = Get-Location
      Write-Host "Our current Working Directory is $outputDirectory"
      $build_path="$outputDirectory\output"
      New-Item -Path "$outputDirectory" -Name "output" -ItemType Directory
      $files = Get-ChildItem "$outputDirectory\services"
      foreach ($f in $files){
          $service_path = $f.FullName 
          $service_name = $f.Name 
          $service_build_path="$build_path\$service_name"
          Write-Host "service_path is $service_path"
          cd $service_path
          New-Item -Path "$build_path" -Name " $service_name" -ItemType Directory
          dotnet build --configuration Release --no-restore   -p:PublishSingleFile=true --output  $service_build_path

      }
      Compress-Archive $build_path\* $outputDirectory\build.zip
